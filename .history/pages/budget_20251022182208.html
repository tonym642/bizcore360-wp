<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget Planner | BizCore360</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background-color:#f9fafb; }
    .card { border:none; border-radius:12px; }
    #moduleMenu .btn { border-radius:10px; transition:all .2s ease-in-out; padding:8px 14px; }
    #moduleMenu .btn.active, #moduleMenu .btn:hover { background-color:#f5f8ff; border-color:#0d6efd; color:#0d6efd; }
    .d-none { display:none!important; }
    .dropdown-item { display:flex; justify-content:space-between; align-items:center; }
    .delete-btn { color:#dc3545; font-size:.9rem; margin-left:8px; cursor:pointer; }
    .delete-btn:hover { color:#a71d2a; }
    .info-section h6 { color:#0d6efd; font-weight:600; margin-top:1rem; }
  </style>
</head>

<body>
<div id="budgetModule" class="container-fluid p-4">
  <div class="card shadow-sm rounded-3">
    <div class="card-body">
      <h4 id="moduleTitle" class="fw-semibold text-primary mb-3">Budget Planner</h4>

      <!-- MENU -->
      <div class="d-flex flex-wrap gap-3 mb-4" id="moduleMenu">
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2 active" data-target="main">
          <i class="bi bi-speedometer2 fs-5 text-primary"></i><span class="fw-medium">Overview</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="info">
          <i class="bi bi-info-circle fs-5 text-secondary"></i><span class="fw-medium">Info</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="ai">
          <i class="bi bi-robot fs-5 text-success"></i><span class="fw-medium">AI Agent</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="tech">
          <i class="bi bi-gear fs-5 text-muted"></i><span class="fw-medium">Tech</span>
        </button>
      </div>

      <!-- OVERVIEW -->
      <div id="main" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-semibold text-primary mb-0">Budget Overview</h5>
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Compare Versions
            </button>
            <ul class="dropdown-menu" id="versionList"></ul>
          </div>
        </div>
        <div id="moduleData" class="text-muted">
          No active budget yet. Use the AI Agent tab to create one.
        </div>
      </div>

        <!-- NEW STATIC INFO PAGE -->
        <div id="info" class="content-section d-none">
          <h5 class="fw-semibold mb-3 text-primary">About the Budget Planner</h5>
          <div class="info-section">

            <h6>Purpose</h6>
            <p>
              The Budget Planner module is designed to help you clearly understand your companyâ€™s financial health,
              forecast cash flow, and make smarter business decisions. Whether youâ€™re managing a startup or a mature
              business, this tool provides a structured way to track income, expenses, and profits month by month.
            </p>

            <h6>How It Works</h6>
            <p>
              This module combines a simple visual overview with an integrated AI assistant.
              The <strong>AI Agent</strong> can walk you through the creation of your first budget step by step,
              asking questions about revenue, fixed and variable costs, and growth goals.
              Once the AI generates a suggested plan, you can set it as your <em>active version</em>.
              The system saves that version automatically, so when you visit this module later, your data remains
              visible in the <strong>Overview</strong> tab.
            </p>

            <h6>Using the Overview</h6>
            <p>
              The Overview tab displays your active or demo budget in a clean, summarized format.
              You can generate a demo to test layout and presentation, or replace it at any time
              with an AI-generated or manually prepared budget. In future updates, multiple budget
              versions can be stored, compared, and analyzed side by side.
            </p>

            <h6>Why It Matters</h6>
            <p>
              Budgeting is one of the most critical pillars of business control.
              It helps you monitor financial discipline, anticipate cash shortfalls,
              and make data-driven decisions before problems occur.
              With consistent use, this module can become the foundation of your financial forecasting
              and strategy sessions.
            </p>

            <h6>Best Practices</h6>
            <ul>
              <li>Update your budget at least once a month or after major business changes.</li>
              <li>Use the AI Agent to identify potential overspending and underperformance trends.</li>
              <li>Compare results with your actual income and expenses to refine accuracy.</li>
              <li>Review and discuss key figures during leadership or investor meetings.</li>
            </ul>

            <h6>Next Steps</h6>
            <p>
              To get started, switch to the <strong>AI Agent</strong> tab and follow the guided process.
              Once your first draft is generated, mark it as active. It will automatically appear
              on your Overview page for quick reference.
            </p>

          </div>
        </div>


      <!-- AI TAB -->
<div id="ai" class="content-section d-none">
  <h5 class="fw-semibold mb-3 text-primary">AI Agent</h5>

  <div class="border rounded-3 p-3 bg-light" style="min-height:320px;max-height:500px;overflow-y:auto;" id="chatContainer">
    <div id="chatMessages" class="d-flex flex-column gap-3">
      <p class="text-muted small">Start chatting with the AI to create your first budget.</p>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-outline-secondary" id="generateDemo">
      <i class="bi bi-magic me-1"></i> Generate Sample Budget
    </button>
    <button class="btn btn-success" id="makeActive">
      <i class="bi bi-check-circle me-1"></i> Make Active
    </button>
  </div>

  <!-- CHAT INPUT BAR -->
  <div class="d-flex align-items-center mt-3 border rounded-pill px-3 py-2 bg-white shadow-sm position-relative">
    <input type="file" id="fileInput" multiple hidden accept="image/*,.pdf,.doc,.docx,.txt" />

    <!-- Upload -->
    <button class="btn btn-link text-secondary p-0 me-2" id="chatAdd" title="Upload File">
      <i class="bi bi-plus-circle fs-5"></i>
    </button>

    <!-- Input -->
    <input type="text" id="chatInput" class="form-control border-0 flex-grow-1" placeholder="Ask anything..." />

    <!-- Mic -->
    <button class="btn btn-link text-secondary p-0 ms-2 me-1" id="chatMic" title="Speak">
      <i class="bi bi-mic fs-5"></i>
    </button>

    <!-- Voice Conversation (TTS toggle) -->
    <button class="btn btn-light border rounded-circle p-0 d-flex align-items-center justify-content-center shadow-sm me-2"
            id="chatVoice" style="width:36px;height:36px;" title="Enable Voice Response">
      <i class="bi bi-soundwave fs-5 text-secondary"></i>
    </button>

    <!-- Send -->
    <button class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
            id="chatSend" style="width:36px;height:36px;">
      <i class="bi bi-send-fill text-white fs-6"></i>
    </button>
  </div>
</div>

<script>
/* ---------------------------------------------------------------------- */
/*  UNIVERSAL AI CHAT (with voice + uploads + speech output)              */
/* ---------------------------------------------------------------------- */
function setupChat() {
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const chatSend = document.getElementById("chatSend");
  const chatAdd = document.getElementById("chatAdd");
  const chatMic = document.getElementById("chatMic");
  const chatVoice = document.getElementById("chatVoice");
  const fileInput = document.getElementById("fileInput");

  // Append message
  function addMessage(text, sender = "user") {
    const msg = document.createElement("div");
    msg.className =
      sender === "user"
        ? "align-self-end bg-primary text-white rounded-3 px-3 py-2"
        : "align-self-start bg-secondary-subtle text-dark rounded-3 px-3 py-2";
    msg.style.maxWidth = "75%";
    msg.innerText = text;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Speak AI replies if enabled
    if (sender === "ai" && voiceEnabled) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      speechSynthesis.speak(utterance);
    }
  }

  // Send message
  async function handleSend() {
    const text = chatInput.value.trim();
    if (!text) return;
    addMessage(text, "user");
    chatInput.value = "";
    addMessage("ðŸ¤– Thinking...", "ai");

    // Simulated AI response (replace later with real API call)
    setTimeout(() => {
      const reply = `Here's a helpful suggestion for: "${text}"`;
      chatMessages.lastChild.innerText = reply;
      if (voiceEnabled) {
        const utter = new SpeechSynthesisUtterance(reply);
        utter.lang = "en-US";
        speechSynthesis.speak(utter);
      }
    }, 1000);
  }

  chatSend.addEventListener("click", handleSend);
  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleSend();
    }
  });

  // Upload
  chatAdd.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => {
    Array.from(fileInput.files).forEach((f) =>
      addMessage(`ðŸ“Ž Uploaded: ${f.name}`, "user")
    );
    fileInput.value = "";
  });

  // Speech-to-Text
  if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recog = new SR();
    recog.lang = "en-US";
    recog.interimResults = false;

    chatMic.addEventListener("click", () => {
      recog.start();
      chatMic.classList.add("text-primary");
    });

    recog.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      chatInput.value = transcript;
      chatMic.classList.remove("text-primary");
    };
    recog.onerror = () => chatMic.classList.remove("text-primary");
    recog.onend = () => chatMic.classList.remove("text-primary");
  } else {
    chatMic.disabled = true;
    chatMic.title = "Voice input not supported";
  }

  // Text-to-Speech Toggle
  let voiceEnabled = false;
  chatVoice.addEventListener("click", () => {
    voiceEnabled = !voiceEnabled;
    if (voiceEnabled) {
      chatVoice.classList.add("bg-primary");
      chatVoice.querySelector("i").classList.add("text-white");
      chatVoice.title = "Voice response ON";
    } else {
      chatVoice.classList.remove("bg-primary");
      chatVoice.querySelector("i").classList.remove("text-white");
      chatVoice.title = "Voice response OFF";
    }
  });
}

// Re-initialize chat after DOM loads (important for module reloads)
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(setupChat, 400);
});
</script>


/* ---------- GLOBAL INITIALIZER (works after injection) ---------- */
const budgetObserver = new MutationObserver(() => {
  const mod = document.getElementById('budgetModule');
  if (mod && !window.budgetInitialized) {
    window.budgetInitialized = true;
    initBudgetModule();
  }
});
budgetObserver.observe(document.body, { childList:true, subtree:true });

function initBudgetModule() {
  const STORAGE_KEY = "budgetVersions";
  const ACTIVE_KEY = "budgetActive";
  const moduleData = document.getElementById("moduleData");
  const versionList = document.getElementById("versionList");

  // MENU SWITCH
  document.querySelectorAll("#moduleMenu button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll("#moduleMenu button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t=btn.dataset.target;
      document.querySelectorAll(".content-section").forEach(s=>s.classList.add("d-none"));
      document.getElementById(t).classList.remove("d-none");
    });
  });

  // STORAGE UTILITIES
  const loadVersions=()=>JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  const saveVersions=v=>localStorage.setItem(STORAGE_KEY,JSON.stringify(v));
  const renderData=b=>{
    moduleData.innerHTML=`
      <div class="card bg-light p-3 rounded-3 shadow-sm">
        <h6 class="fw-semibold mb-2 text-primary">${b.name}</h6>
        <p class="small text-muted mb-2">Created: ${new Date(b.timestamp).toLocaleString()}</p>
        <div>${b.output}</div>
      </div>`;
    localStorage.setItem(ACTIVE_KEY,JSON.stringify(b));
  };

  const refreshDropdown=()=>{
    const versions=loadVersions();
    versionList.innerHTML="";
    if(!versions.length){versionList.innerHTML=`<li><span class="dropdown-item text-muted">No saved versions</span></li>`;return;}
    versions.forEach((v,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`
        <span class="dropdown-item">
          <span>${v.name}</span>
          <i class="bi bi-trash delete-btn" data-index="${i}" title="Delete"></i>
        </span>`;
      li.querySelector(".dropdown-item").addEventListener("click",e=>{
        if(e.target.classList.contains("delete-btn"))return;
        renderData(v);
      });
      li.querySelector(".delete-btn").addEventListener("click",()=>{
        if(confirm("Delete this version?")){
          versions.splice(i,1);
          saveVersions(versions);
          refreshDropdown();
        }
      });
      versionList.appendChild(li);
    });
  };

  const loadActive=()=>{
    const a=localStorage.getItem(ACTIVE_KEY);
    if(a)renderData(JSON.parse(a));
  };

  // BUTTONS
  document.getElementById("generateDemo").addEventListener("click",()=>{
    const demo={
      name:"Demo Budget - Small Business",
      timestamp:Date.now(),
      output:`
        <strong>Revenue:</strong><br>
        - Product Sales: $18,500<br>
        - Service Income: $7,200<br>
        - Other Income: $800<br><br>
        <strong>Operating Expenses:</strong><br>
        - Rent & Utilities: $3,000<br>
        - Payroll & Benefits: $9,000<br>
        - Marketing & Advertising: $1,200<br>
        - Office Supplies: $350<br>
        - Insurance: $400<br>
        - Software Subscriptions: $250<br>
        - Travel & Meals: $450<br>
        - Miscellaneous: $200<br><br>
        <strong>Total Expenses:</strong> $14,850<br>
        <strong>Net Profit:</strong> $11,650<br>
        <em>Notes:</em> Strong month with moderate ad spend and lower utility costs.`
    };
    const v=loadVersions(); v.push(demo); saveVersions(v);
    renderData(demo); refreshDropdown();
    document.querySelector('[data-target="main"]').click();
  });

  document.getElementById("makeActive").addEventListener("click",()=>{
    const aiBudget={
      name:"AI-Generated Budget",
      timestamp:Date.now(),
      output:`
        <strong>Revenue:</strong><br>
        - Product Sales: $20,000<br>
        - Consulting Services: $5,000<br>
        - Recurring Subscriptions: $1,200<br><br>
        <strong>Operating Expenses:</strong><br>
        - Payroll & Benefits: $10,000<br>
        - Rent & Utilities: $2,800<br>
        - Marketing & Advertising: $1,000<br>
        - Software & Licenses: $300<br>
        - Travel & Meals: $500<br>
        - Miscellaneous: $150<br><br>
        <strong>Total Expenses:</strong> $14,750<br>
        <strong>Net Profit:</strong> $11,450<br>
        <em>Notes:</em> AI-optimized scenario projecting consistent growth and lower overhead.`
    };
    const v=loadVersions(); v.push(aiBudget); saveVersions(v);
    renderData(aiBudget); refreshDropdown();
    document.querySelector('[data-target="main"]').click();
  });

  refreshDropdown(); loadActive();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

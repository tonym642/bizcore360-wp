<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget Planner | BizCore360</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background-color:#f9fafb; }
    .card { border:none; border-radius:12px; }
    #moduleMenu .btn { border-radius:10px; transition:all .2s ease-in-out; padding:8px 14px; }
    #moduleMenu .btn.active, #moduleMenu .btn:hover { background-color:#f5f8ff; border-color:#0d6efd; color:#0d6efd; }
    .d-none { display:none!important; }
    .dropdown-item { display:flex; justify-content:space-between; align-items:center; }
    .delete-btn { color:#dc3545; font-size:.9rem; margin-left:8px; cursor:pointer; }
    .delete-btn:hover { color:#a71d2a; }
    .info-section h6 { color:#0d6efd; font-weight:600; margin-top:1rem; }
  </style>
</head>

<body>
<div id="budgetModule" class="container-fluid p-4">
  <div class="card shadow-sm rounded-3">
    <div class="card-body">
      <h4 id="moduleTitle" class="fw-semibold text-primary mb-3">Budget Planner</h4>

      <!-- MENU -->
      <div class="d-flex flex-wrap gap-3 mb-4" id="moduleMenu">
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2 active" data-target="main">
          <i class="bi bi-speedometer2 fs-5 text-primary"></i><span class="fw-medium">Overview</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="info">
          <i class="bi bi-info-circle fs-5 text-secondary"></i><span class="fw-medium">Info</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="ai">
          <i class="bi bi-robot fs-5 text-success"></i><span class="fw-medium">AI Agent</span>
        </button>
        <button class="btn btn-light border shadow-sm d-flex align-items-center gap-2" data-target="tech">
          <i class="bi bi-gear fs-5 text-muted"></i><span class="fw-medium">Tech</span>
        </button>
      </div>

      <!-- OVERVIEW -->
      <div id="main" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-semibold text-primary mb-0">Budget Overview</h5>
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Compare Versions
            </button>
            <ul class="dropdown-menu" id="versionList"></ul>
          </div>
        </div>
        <div id="moduleData" class="text-muted">
          No active budget yet. Use the AI Agent tab to create one.
        </div>
      </div>

      <!-- INFO PAGE -->
        <div id="info" class="content-section d-none">
          <h5 class="fw-semibold mb-3 text-primary">About the Budget Planner</h5>
          <div class="info-section">
            <h6>Purpose</h6>
            <p>
              The Budget Planner module is designed to help you clearly understand your company’s financial health,
              forecast cash flow, and make smarter business decisions. Whether you’re managing a startup or a mature
              business, this tool provides a structured way to track income, expenses, and profits month by month.
            </p>

            <h6>How It Works</h6>
            <p>
              This module combines a simple visual overview with an integrated AI assistant.
              The <strong>AI Agent</strong> walks you through creating your first budget step by step,
              asking about revenue, fixed costs, and goals.
              Once the AI generates a plan, you can mark it as your <em>active version</em>.
              It’s stored automatically and appears in the <strong>Overview</strong> tab.
            </p>

            <h6>Why It Matters</h6>
            <p>
              Budgeting helps you monitor financial discipline, anticipate cash shortfalls,
              and make data-driven decisions before problems occur.
              With consistent use, this module can serve as the foundation for your financial strategy.
            </p>

            <h6>Best Practices</h6>
            <ul>
              <li>Update your budget monthly or after major changes.</li>
              <li>Use the AI Agent to refine trends and reduce errors.</li>
              <li>Review data during leadership or investor meetings.</li>
            </ul>
          </div>
        </div>


      <!-- AI TAB -->
      <div id="ai" class="content-section d-none">
        <h5 class="fw-semibold mb-3 text-primary">AI Agent</h5>
        <div class="border rounded-3 p-3 bg-light" style="min-height:320px;max-height:500px;overflow-y:auto;" id="chatContainer">
          <div id="chatMessages" class="d-flex flex-column gap-3">
            <p class="text-muted small">Start chatting with the AI to create your first budget.</p>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-outline-secondary" id="generateDemo">
            <i class="bi bi-magic me-1"></i> Generate Sample Budget
          </button>
          <button class="btn btn-success" id="makeActive">
            <i class="bi bi-check-circle me-1"></i> Make Active
          </button>
        </div>

        <div class="d-flex align-items-center mt-3 border rounded-pill px-3 py-2 bg-white shadow-sm">
          <input type="text" id="chatInput" class="form-control border-0 flex-grow-1" placeholder="Ask anything..." />
          <button class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
            id="chatSend" style="width:36px;height:36px;">
            <i class="bi bi-send-fill text-white fs-6"></i>
          </button>
        </div>
      </div>

      <div id="tech" class="content-section d-none">
        <h5 class="fw-semibold mb-3 text-primary">Technical Data</h5>
        <pre id="techData" class="small bg-light p-3 rounded-3"></pre>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- GLOBAL INITIALIZER (works after injection) ---------- */
const budgetObserver = new MutationObserver(() => {
  const mod = document.getElementById('budgetModule');
  if (mod && !window.budgetInitialized) {
    window.budgetInitialized = true;
    initBudgetModule();
  }
});
budgetObserver.observe(document.body, { childList:true, subtree:true });

function initBudgetModule() {
  const STORAGE_KEY = "budgetVersions";
  const ACTIVE_KEY = "budgetActive";
  const moduleData = document.getElementById("moduleData");
  const versionList = document.getElementById("versionList");

  // MENU SWITCH
  document.querySelectorAll("#moduleMenu button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll("#moduleMenu button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t=btn.dataset.target;
      document.querySelectorAll(".content-section").forEach(s=>s.classList.add("d-none"));
      document.getElementById(t).classList.remove("d-none");
    });
  });

  // STORAGE UTILITIES
  const loadVersions=()=>JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  const saveVersions=v=>localStorage.setItem(STORAGE_KEY,JSON.stringify(v));
  const renderData=b=>{
    moduleData.innerHTML=`
      <div class="card bg-light p-3 rounded-3 shadow-sm">
        <h6 class="fw-semibold mb-2 text-primary">${b.name}</h6>
        <p class="small text-muted mb-2">Created: ${new Date(b.timestamp).toLocaleString()}</p>
        <div>${b.output}</div>
      </div>`;
    localStorage.setItem(ACTIVE_KEY,JSON.stringify(b));
  };

  const refreshDropdown=()=>{
    const versions=loadVersions();
    versionList.innerHTML="";
    if(!versions.length){versionList.innerHTML=`<li><span class="dropdown-item text-muted">No saved versions</span></li>`;return;}
    versions.forEach((v,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`
        <span class="dropdown-item">
          <span>${v.name}</span>
          <i class="bi bi-trash delete-btn" data-index="${i}" title="Delete"></i>
        </span>`;
      li.querySelector(".dropdown-item").addEventListener("click",e=>{
        if(e.target.classList.contains("delete-btn"))return;
        renderData(v);
      });
      li.querySelector(".delete-btn").addEventListener("click",()=>{
        if(confirm("Delete this version?")){
          versions.splice(i,1);
          saveVersions(versions);
          refreshDropdown();
        }
      });
      versionList.appendChild(li);
    });
  };

  const loadActive=()=>{
    const a=localStorage.getItem(ACTIVE_KEY);
    if(a)renderData(JSON.parse(a));
  };

  // BUTTONS
  document.getElementById("generateDemo").addEventListener("click",()=>{
    const demo={
      name:"Demo Budget - Small Business",
      timestamp:Date.now(),
      output:`
        <strong>Revenue:</strong><br>
        - Product Sales: $18,500<br>
        - Service Income: $7,200<br>
        - Other Income: $800<br><br>
        <strong>Operating Expenses:</strong><br>
        - Rent & Utilities: $3,000<br>
        - Payroll & Benefits: $9,000<br>
        - Marketing & Advertising: $1,200<br>
        - Office Supplies: $350<br>
        - Insurance: $400<br>
        - Software Subscriptions: $250<br>
        - Travel & Meals: $450<br>
        - Miscellaneous: $200<br><br>
        <strong>Total Expenses:</strong> $14,850<br>
        <strong>Net Profit:</strong> $11,650<br>
        <em>Notes:</em> Strong month with moderate ad spend and lower utility costs.`
    };
    const v=loadVersions(); v.push(demo); saveVersions(v);
    renderData(demo); refreshDropdown();
    document.querySelector('[data-target="main"]').click();
  });

  document.getElementById("makeActive").addEventListener("click",()=>{
    const aiBudget={
      name:"AI-Generated Budget",
      timestamp:Date.now(),
      output:`
        <strong>Revenue:</strong><br>
        - Product Sales: $20,000<br>
        - Consulting Services: $5,000<br>
        - Recurring Subscriptions: $1,200<br><br>
        <strong>Operating Expenses:</strong><br>
        - Payroll & Benefits: $10,000<br>
        - Rent & Utilities: $2,800<br>
        - Marketing & Advertising: $1,000<br>
        - Software & Licenses: $300<br>
        - Travel & Meals: $500<br>
        - Miscellaneous: $150<br><br>
        <strong>Total Expenses:</strong> $14,750<br>
        <strong>Net Profit:</strong> $11,450<br>
        <em>Notes:</em> AI-optimized scenario projecting consistent growth and lower overhead.`
    };
    const v=loadVersions(); v.push(aiBudget); saveVersions(v);
    renderData(aiBudget); refreshDropdown();
    document.querySelector('[data-target="main"]').click();
  });

  refreshDropdown(); loadActive();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
